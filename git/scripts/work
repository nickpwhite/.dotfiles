#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: $(basename "$0") <branch_name>" >&2
  exit 1
fi

branch_name=$1
directory_name="../$branch_name"

if [[ ! -d "$directory_name" ]]; then
  git worktree add -b "$branch_name" "$directory_name"
  if [[ -f apps/web/.env.local ]]; then
    ln -s "$(pwd)/apps/web/.env.local" "$directory_name/apps/web/.env.local"
  fi
fi
pushd "$directory_name" > /dev/null
npm install
popd > /dev/null
tmux new-window -c "$directory_name" -n "$branch_name" \
  bash -lc 'nvim; exec "${SHELL:-/bin/bash}" -l'

tmux split-window -h -l 55 -c "$directory_name" \
  bash -lc 'opencode; exec "${SHELL:-/bin/bash}" -l'

tmux select-pane -L

tmux split-window -v -l 20 -c "$directory_name" \
  bash -lc 'npm run dev; exec "${SHELL:-/bin/bash}" -l'
tmux split-window -h -c "$directory_name"
